{% extends "layout.html" %} 
{% block content %}
<div class="block-header">
	<h2>ATEMSCHUTZ KONTROLLE</h2>
</div>
<div class="row clearfix">
	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
		<div class="card">
			<div class="header">
				<h2>AUFGABEN</h2>
				<small></small>
			</div>
			<div class="body">
			</div>
		</div>
    </div>
    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
        <div class="card">
            <div class="header bg-green">
                <h2>ERFÜLLT</h2>
                <small>In diesem Jahr noch nicht das mind. Soll erreicht</small>
            </div>
            <div class="body">
                <div class="row clearfix">
                    <div class="col-md-3">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
        <div class="card">
            <div class="header bg-red">
                <h2>NICHT ERFÜLLT</h2>
                <small>In diesem Jahr noch nicht das mind. Soll erreicht</small>
            </div>
            <div class="body">
                <div class="row clearfix">
                    <div class="col-md-3">
                             
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
		<div class="card">
            <div class="header">
                <h2>ANSICHT ÜBER ALLES</h2>
                <ul class="header-dropdown m-r--5">
                    <button type="button" class="btn btn-default waves-effect m-r-20" data-toggle="modal" data-entry-id="-1" data-target="#EntryModal">Neuer Eintrag</button>
                </ul>
            </div>
            <div class="body">
                    
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover table-all dataTable">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Kategorie</th>
                                <th>Name</th>
                                <th>Dauer</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in entries %}
                            <tr>
                                <td>{{ entry.datum.strftime('%d.%m.%Y') }}</td>
                                <td>{{ entry.category.name }}</td>
                                <td>{{ entry.member.vorname }} {{ entry.member.name }}</td>
                                <td>{{ entry.time }}</td>
                                <td><a href="#" class="menu-toggle" data-toggle="modal" 
                                        data-entry-id="{{ entry.id }}"
                                        data-entry-datum="{{ entry.datum.strftime('%d.%m.%Y') }}"
                                        data-entry-member="{{ entry.member_id }}"
                                        data-entry-category="{{ entry.category_id }}"
                                        data-entry-time="{{ entry.time }}"
                                        data-target="#EntryModal"><i class="material-icons">edit</i></a> 
									<a href="#" class="menu-toggle" data-toggle="modal" data-entry-id="{{ entry.id }}" data-target="#DeleteEntryModal"><i class="material-icons">delete</i></a>
								</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New / Edit Entry Modal START -->
<div class="modal fade" id="EntryModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="EntryModalLabel">Neuer Atemschutzeintrag hinzufügen </h4>
                </div>
                <form class="form" data-category="entry">
                    <input type="hidden" id="entryId" />
                    <div class="modal-body mx-3" id="EntryModalBody">
                        <div class="form-group">
                            <div class="form-line">
                                <label for="datum">Datum:</label>
                                <input type="text" id="datum" class="datepicker form-control" placeholder="Datum" required />
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-line">
                                <label for="category">Kategorie:</label>
                                <select class="select form-control show-tick" id="category" required>
                                    <option data-hidden="true">Kategorie auswählen</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-line">
                                <label for="firefighters">Personen:</label>
                                <select class="select form-control show-tick" id="firefighters" data-live-search="true" multiple>
                                    <option data-hidden="true">Personen auswählen</option>
                                    {% for firefighter in firefighters %}
                                        <option value="{{ firefighter.id }}">{{ firefighter.vorname }} {{ firefighter.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="form-line">
                                <label for="dauer">Dauer:</label>
                                <input type="number" class="form-control" id="dauer" placeholder="Dauer" required>
                            </div>
                            <span class="input-group-addon">Minuten</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-link waves-effect">SPEICHERN</button>
                    <button type="button" class="btn btn-link waves-effect" data-dismiss="modal">ABBRECHEN</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<!-- New / Edit Entry Modal END -->

<!-- Delete Entry Modal START-->
<div class="modal fade" id="DeleteEntryModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content modal-col-red">
			<div class="modal-header">
				<h4 class="modal-title" id="DeleteEntryModalLabel">Eintrag löschen</h4>
			</div>
			<div class="modal-body" id="DeleteEntryModalBody">
				<input type="hidden" name="entryId" />
				Soll der Eintrag defintiv gelöscht werden?
			</div>
			<div class="modal-footer">
				<button type="button" id="btnDeleteEntry" class="btn btn-link waves-effect">LÖSCHEN</button>
				<button type="button" class="btn btn-link waves-effect" data-dismiss="modal">ABBRECHEN</button>
			</div>
		</div>
	</div>
</div>
<!-- Delete Entry Modal END -->
{% endblock %}

{% block javascript %}
<!-- Moment Plugin Js -->
<script src="/static/plugins/momentjs/moment.js"></script>

<!-- Bootstrap Material Datetime Picker Plugin Js -->
<script src="/static/plugins/bootstrap-material-datetimepicker/js/bootstrap-material-datetimepicker.js"></script>

<script src="/static/plugins/jquery-datatable/jquery.dataTables.js"></script>
<script src="/static/plugins/jquery-datatable/skin/bootstrap/js/dataTables.bootstrap.js"></script>
<script src="/static/plugins/jquery-datatable/extensions/export/dataTables.buttons.min.js"></script>
<script src="/static/plugins/jquery-datatable/extensions/export/buttons.flash.min.js"></script>
<script src="/static/plugins/jquery-datatable/extensions/export/jszip.min.js"></script>
<script src="/static/plugins/jquery-datatable/extensions/export/pdfmake.min.js"></script>
<script src="/static/plugins/jquery-datatable/extensions/export/vfs_fonts.js"></script>
<script src="/static/plugins/jquery-datatable/extensions/export/buttons.html5.min.js"></script>
<script src="/static/plugins/jquery-datatable/extensions/export/buttons.print.min.js"></script>

<script>
var curday = function(sp){
today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1; //As January is 0.
    var yyyy = today.getFullYear();

    if(dd<10) dd='0'+dd;
    if(mm<10) mm='0'+mm;
    return (mm+sp+dd+sp+yyyy);
};

$('.datepicker').bootstrapMaterialDatePicker({
    format: 'DD.MM.YYYY',
    clearButton: true,
    weekStart: 1,
    time: false
});

$('.table-all').DataTable({
    dom: 'Bfrtip',
    responsive: true,
    buttons: [
        { extend: 'print',  text: 'Drucken', title: 'Atemschutzkontrolle per ' + curday('.'), footer: 'true', exportOptions: { columns: [0,1,2,3] } },
        { extend: 'pdf',  text: 'PDF', title: 'Atemschutzkontrolle per ' + curday('.'), footer: 'true', exportOptions: { columns: [0,1,2,3] } }
    ]
});

$('#EntryModal').on('show.bs.modal', function(e) {
    $('.select').selectpicker();

    //get data-id attribute of the clicked element
	var entryId = $(e.relatedTarget).data('entry-id');

    $('#CategoryModalLabel').html("Neuer Eintrag hinzufügen")
    $("#datum").val('')
    $("#firefighter").val('')
	$("#category").val('')
    $("#dauer").val('')

    //If Category Id avaiable Edit Button was pressed.
	if(entryId > -1) {
		$('#CategoryModalLabel').html("Eintrag ändern")
        $("#entryId").val($(e.relatedTarget).data('entry-id'))
        $("#datum").val($(e.relatedTarget).data('entry-datum'))
        $("#firefighters").val($(e.relatedTarget).data('entry-member'))
		$("#category").val($(e.relatedTarget).data('entry-category'))
        $("#dauer").val($(e.relatedTarget).data('entry-time'))
        $('.select').selectpicker('refresh');
    }
});

$('.form').submit('click', function () {
	event.preventDefault();

	if($(this).data('category') === 'entry') {
		$.ajax({
			url: '/atemschutz/entry',
			type: 'POST',
			data: { entry_id: $('#entryId').val(), datum: $('#datum').val(), category: $('#category').val(), firefighters: $('#firefighters').val(), dauer: $('#dauer').val() },
			success: function(response) {
				$('#EntryModal').modal('hide')
				location.reload();
			},
			error: function(error) {
				var errorJson = JSON.parse(error.responseText);
				console.log(errorJson)
				$('#EntryModalBody').addClass('error');
				$('#EntryModalBody').prepend('<div class="alert alert-danger">' + errorJson.message + '</div>');
			}
		});
	}
});

$('#DeleteEntryModal').on('show.bs.modal', function(e) {
	// Get data-category-name attribute of the entry 
	$("input[name='entryId']").val($(e.relatedTarget).data('entry-id'))
});

$('#btnDeleteEntry').click(function() {
	$.ajax({
		url: '/atemschutz/entry/'+$("input[name='entryId']").val(),
		type: 'DELETE',
		success: function(response) {
			$('#CategoryModal').modal('hide')
			location.reload();
		},
		error: function(error) {
			var errorJson = JSON.parse(error.responseText);
			console.log(errorJson)
			$('#EntryCategoryModalBody').addClass('error');
			$('#EntryCategoryModalBody').prepend('<div class="alert alert-danger">' + errorJson.message + '</div>');
		}
	});
});

Morris.Donut({
        element: chart,
        data: [{
                label: 'Jam',
                value: 25
            }, {
                    label: 'Frosted',
                    value: 40
                }, {
                    label: 'Custard',
                    value: 25
                }, {
                    label: 'Sugar',
                    value: 10
                }],
            colors: ['rgb(233, 30, 99)', 'rgb(0, 188, 212)', 'rgb(255, 152, 0)', 'rgb(0, 150, 136)'],
            formatter: function (y) {
                return y + '%'
            }
        });
</script>
{% endblock %}