{% extends "admin/layout.html" %} 
{% block content %}
<div class="block-header">
	<h2>PUSH MELDUNGEN</h2>
</div>
<div class="row">
	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
		<div class="card">
			<div class="header">
				<h2>AKTIVIEREN</h2>
				<small></small>
			</div>
			<div class="body">
			    <p>Mit dieser Funktion k%F6nnen Push Meldungen f%FCr dieses Geraet aktiviert / deaktiviert werden. <br/>
				Aktuell werden folgende Meldungen unterstuetzt:
			    <ul>
				<li>Einsatzalarme</li>
			    </ul>
			    <blockquote class="m-b-25">
                                <p>Beim Aktivieren wird eine Geraete Berechtigung angefordert. Diese muss angenommen werden!</p>
                            </blockquote>
			    <button type="button" id="btnActivate" class="btn waves-effect" onClick="activateNotification()">AKTIVIEREN</button>
			</div>
		</div>
	</div>
</div>
{% endblock %}
{% block javascript %}
<script>
    navigator.serviceWorker.register('/static/js/service-push.js')
	.then(function(registration) {
	    console.log('Service worker successfully registered.');
    })
	.catch(function(err) {
	    $('#btnActivate').addClass('disabled');
	    console.error('Unable to register service worker.', err);
    });
    
    // We need the service worker registration to check for a subscription
    navigator.serviceWorker.ready.then(function (reg) {
	// Do we already have a push message subscription?
	reg.pushManager.getSubscription()
	    .then(function (subscription) {
		if (!subscription) {
		    console.log('Not yet subscribed to Push')

		    isSubscribed = false;
		    $('#btnActivate').html('AKTIVIEREN');
		    $('#btnActivate').addClass('btn-success');
		} else {
		    // initialize status, which includes setting UI elements for subscribed status
		    // and updating Subscribers list via push
		    isSubscribed = true;
		    $('#btnActivate').html('DEAKTIVIEREN');
		    $('#btnActivate').addClass('btn-danger');
		}
	    })
	    .catch(function (err) {
		console.log('Error during getSubscription()', err);
	    });
    });

    function askPermission() {
	return new Promise(function(resolve, reject) {
	    const permissionResult = Notification.requestPermission(function(result) {
	      resolve(result);
	    });

	    if (permissionResult) {
	      permissionResult.then(resolve, reject);
	    }
	})
	.then(function(permissionResult) {
	    if (permissionResult !== 'granted') {
	      throw new Error('We weren\'t granted permission.');
	    }
	});
    }
    
    function activateNotification() {
	return navigator.serviceWorker.register('/static/js/service-push.js')
	.then(function(registration) {
	    const subscribeOptions = {
		userVisibleOnly: true,
		applicationServerKey: urlBase64ToUint8Array(
			'BPG5qhEm8cTDFY7rh5hnbKM1omHbCl1Bz1eRT1S31Wk8qakYFxPW9KJGSWMP1JW4ZRLTM_9Zv6oy7hssbPgwmAo'
		)
	    };
	    return registration.pushManager.subscribe(subscribeOptions);
	})
	.then(function(pushSubscription) {
	  console.log('Received PushSubscription: ', JSON.stringify(pushSubscription));
	  return pushSubscription;
	});
    }
    
    function urlBase64ToUint8Array(base64String) {
	var padding = '='.repeat((4 - base64String.length % 4) % 4);
	var base64 = (base64String + padding)
	  .replace(/\-/g, '+')
	  .replace(/_/g, '/');

	var rawData = window.atob(base64);
	var outputArray = new Uint8Array(rawData.length);

	for (var i = 0; i < rawData.length; ++i) {
	  outputArray[i] = rawData.charCodeAt(i);
	}
	return outputArray;
    }
</script>
{% endblock %}
